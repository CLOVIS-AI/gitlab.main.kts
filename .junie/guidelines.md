# Project Guidelines

## Project overview

This project is `.gitlab-ci.main.kts`, part of the OpenSavvy organization. This project aims to provide a Kotlin DSL for declaring GitLab CI pipelines.

As an example, the following GitLab CI pipeline:
```yaml
stages:
  - test

helloWorld:
  stage: test
  script:
    - echo "Hello world"
```

can be written:
```kotlin
#!/usr/bin/env kotlin

@file:DependsOn("dev.opensavvy.gitlab:gitlab-ci-kotlin-jvm:VERSION-HERE") // See https://gitlab.com/opensavvy/automation/gitlab-ci.kt/-/releases

import opensavvy.gitlab.ci.*
import opensavvy.gitlab.ci.script.*

val pipeline = gitlabCi {
	val test by stage()

	val helloWorld by job(stage = test) {
		script {
			shell("echo 'Hello world'")
		}
	}
}

pipeline.println()
```

The project is mainly intended to be used within Kotlin Scripts (files with the extension `.main.kts`) which allows declaring dependencies.

The source code is in the folder `gitlab-ci-kotlin` and the documentation website is in the folder `docs/website`. This is a Gradle project.

## Adapting declarations from YAML to Kotlin

You will often be asked to convert the YAML documentation into Kotlin examples. While doing so, follow the rules outlined in this section.

- Each YAML element that contains child nodes should be a Kotlin class with an internal constructor that is instantiated in the class corresponding to the outer element.
- Each YAML element that doesn't contain child nodes should be a Kotlin function.
- All public classes and functions should be annotated with `@GitLabDsl`.

Public functions should be documented using the following format:
```kotlin
/**
 * A short sentence that describes what the function does. Be succinct: in some UIs, only this line will be displayed to the user.
 * 
 * If more precision is necessary, for example, to explain edge cases or peculiarities, add one
 * or more additional paragraphs to describe them.
 * 
 * ### Example
 * 
 * Always add a Kotlin example for users to know how to call this function. 
 * This example should be surrounded by proper code fences.
 * For most functions, we assume that we are within the `gitlabCi {}` function. Thus, no imports are necessary.
 * 
 * Usually, the example is self-explanatory enough that no accompanying text is necessary. However, if the behavior may be unexpected or confusing, then add one or more sentences to explain it.
 * 
 * ### Example: some other scenario
 * 
 * If this function may be useful in more than one scenario, you may add one or more additional example sections to showcase them. Most functions do not need these.
 * 
 * ### External resources
 * 
 * The external resources section links to online resources that are not part of this project. Typically, it is simply an unordered list of links. Typically, it contains a single link title "Official documentation" which contains a link for specifically that symbol.
 */
```

For example:
```kotlin
	/**
	 * Declares the URL on which the deployed environment is available.
	 *
	 * ### Example
	 *
	 * ```kotlin
	 * val deployQa by job {
	 *     script {
	 *         // â€¦
	 *     }
	 *
	 *     environment {
	 *         name("qa")
	 *         url("https://qa.your.app/dashboard")
	 *     }
	 * }
	 * ```
	 *
	 * ### Example: dynamic URL
	 *
	 * The URL can be generated by the job itself by combining this feature with [Artifacts.dotenv]:
	 * ```kotlin
	 * val deployQa by job {
	 *     script {
	 *         shell("QA_URL=$(./generate-url) >>qa.env")
	 *     }
	 *
	 *     artifacts {
	 *         dotenv("qa.env")
	 *     }
	 *
	 *     environment {
	 *         name("qa")
	 *         url($$"$QA_URL")
	 *     }
	 * }
	 * ```
	 *
	 * ### External resources
	 *
	 * - [Official documentation](https://docs.gitlab.com/ci/yaml/#environmenturl)
	 */
	@GitLabCiDsl
	fun url(url: String) {
		this.url = url
	}
```

When in doubt about applying these rules, observe the existing code or ask the user.

## Testing

Always run tests with `./gradlew check`. Do not attempt to run tests in any other way.

Many tests are file-based: the test verifies that output doesn't change by comparing to a given file. If you must change the generated files (but only do so when necessary), run `./gradlew check -PoverrideTestResults` to override the generated files.
